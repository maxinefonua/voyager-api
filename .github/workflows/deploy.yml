name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Build with Maven
      run: mvn clean package -DskipTests
    
    - name: Verify JAR file
      run: |
        JAR_PATH=$(find target -name "*uber.jar" -o -name "*with-dependencies.jar" -o -name "*.jar" | head -1)
        if [ -z "$JAR_PATH" ]; then
          echo "JAR file not found. Checking target directory:"
          ls -la target/
          exit 1
        fi
        echo "JAR_PATH=$JAR_PATH" >> $GITHUB_ENV
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
    
    - name: Deploy to EC2
      env:
        EC2_HOST: ec2-13-57-240-243.us-west-1.compute.amazonaws.com
      run: |
        # Copy JAR to EC2
        scp -o StrictHostKeyChecking=no "${{ env.JAR_PATH }}" ec2-user@$EC2_HOST:/tmp/voyager-api.jar
        
        # Run deployment script
        ssh -o StrictHostKeyChecking=no ec2-user@$EC2_HOST "bash /home/ec2-user/api/scripts/deploy.sh"
