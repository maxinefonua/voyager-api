name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Clone and build voyager-commons
      run: |
        git clone https://github.com/maxinefonua/voyager-commons.git
        cd voyager-commons
        mvn clean install -DskipTests
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Build with Maven
      run: mvn clean package -DskipTests
    
    - name: Verify JAR file
      run: |
        JAR_PATH=$(find target -name "*.jar" -type f | head -1)
        if [ -z "$JAR_PATH" ]; then
          echo "JAR file not found. Checking target directory:"
          ls -la target/
          exit 1
        fi
        echo "JAR_PATH=$JAR_PATH" >> $GITHUB_ENV
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
    
    - name: Deploy to EC2
      env:
        EC2_HOST: ec2-13-57-240-243.us-west-1.compute.amazonaws.com
      run: |
        # Get version info
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout 2>/dev/null || echo "1.0.0")
        SHORT_SHA=$(git rev-parse --short HEAD)
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        
        # Rename JAR
        NEW_JAR_NAME="voyager-api-${VERSION}-${SHORT_SHA}-${TIMESTAMP}.jar"
        cp "${{ env.JAR_PATH }}" "/tmp/$NEW_JAR_NAME"
        
        echo "ðŸ“¦ Deploying: $NEW_JAR_NAME"
        
        # Copy to EC2
        scp -o StrictHostKeyChecking=no "/tmp/$NEW_JAR_NAME" ec2-user@$EC2_HOST:/tmp/
        
        # Run deployment script
        ssh -o StrictHostKeyChecking=no ec2-user@$EC2_HOST "bash /home/ec2-user/api/scripts/deploy.sh"
        
        # Clean up
        rm -f "/tmp/$NEW_JAR_NAME"
