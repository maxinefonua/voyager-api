name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        # Remove settings-path parameter for now
    
    - name: Configure Maven for GitHub Packages
      run: |
        # First, check what exists at workspace root
        echo "ðŸ“ Workspace contents:"
        ls -la ${{ github.workspace }}/
        
        # Remove any existing settings.xml directory/file
        rm -rf ${{ github.workspace }}/settings.xml
        
        # Create Maven directory
        mkdir -p ~/.m2
        
        # Create settings.xml with proper authentication
        cat > ~/.m2/settings.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                      https://maven.apache.org/xsd/settings-1.0.0.xsd">
          <servers>
            <server>
              <id>github</id>
              <username>${{ github.actor }}</username>
              <password>${{ secrets.GITHUB_TOKEN }}</password>
            </server>
          </servers>
        </settings>
        EOF
        
        echo "âœ… Created ~/.m2/settings.xml"
        echo "ðŸ“‹ Settings.xml content:"
        cat ~/.m2/settings.xml
    
    - name: Validate Maven configuration
      run: |
        echo "ðŸ” Validating Maven setup..."
        echo "Maven home: ~/.m2"
        echo "Settings.xml exists: $(ls -la ~/.m2/settings.xml 2>/dev/null && echo 'Yes' || echo 'No')"
        
        # Test repository configuration
        echo "ðŸ“¦ Testing repository access..."
        mvn help:effective-pom -Doutput=effective-pom.xml || echo "Continuing with build..."
    
    - name: Build with Maven
      run: mvn clean package -DskipTests
    
    - name: Verify JAR file
      run: |
        echo "ðŸ” Looking for JAR files..."
        find . -name "*.jar" -type f | head -10
        
        JAR_PATH=$(find target -name "*.jar" -type f | head -1)
        if [ -z "$JAR_PATH" ]; then
          echo "âŒ JAR file not found. Checking target directory:"
          ls -la target/
          echo "ðŸ“‹ Checking for build errors:"
          if [ -f "target/surefire-reports" ]; then
            find target -name "*.txt" -type f -exec echo "=== {} ===" \; -exec head -20 {} \;
          fi
          exit 1
        fi
        echo "âœ… Found JAR: $JAR_PATH"
        echo "JAR_PATH=$JAR_PATH" >> $GITHUB_ENV
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
    
    - name: Deploy to EC2
      env:
        EC2_HOST: ec2-13-57-240-243.us-west-1.compute.amazonaws.com
      run: |
        # Get version info
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout 2>/dev/null || echo "1.0.0")
        SHORT_SHA=$(git rev-parse --short HEAD)
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        
        # Rename JAR
        NEW_JAR_NAME="voyager-api-${VERSION}-${SHORT_SHA}-${TIMESTAMP}.jar"
        cp "${{ env.JAR_PATH }}" "/tmp/$NEW_JAR_NAME"
        
        echo "ðŸ“¦ Deploying: $NEW_JAR_NAME"
        
        # Copy to EC2
        scp -o StrictHostKeyChecking=no "/tmp/$NEW_JAR_NAME" ec2-user@$EC2_HOST:/tmp/
        
        # Run deployment script
        ssh -o StrictHostKeyChecking=no ec2-user@$EC2_HOST "bash /home/ec2-user/api/scripts/deploy.sh"
        
        # Clean up
        rm -f "/tmp/$NEW_JAR_NAME"
